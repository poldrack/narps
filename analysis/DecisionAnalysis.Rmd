---
title: "Decision analysis"
output: html_notebook
---

Analyze decisions across teams.

```{r setup, echo=FALSE,message=FALSE}
library(plyr)
library(tidyverse)
library(lmerTest)
library(lme4)
library(emmeans) 
library(pscl)
library(arm)
library(MuMIn)

```

### Data setup 

Load the data and clean up some variables.  Requires metadata that is created by PrepareMetadata.ipynb

```{r loadData}
# load and clean up data
narps_df = read_csv('/Users/nichols/git/narps-poldrack/metadata/all_metadata.csv')

narps_df <- narps_df %>% 
  mutate(package = recode_factor(TSc_SW,
                      SPM12 = "SPM",
                      SPM8 = "SPM",
                      SPM5 = "SPM",
                      nistats = "Other",
                      PALM = "Other",
                      randomise = "Other"),
         testing = recode_factor(TSc_testing,
                      Randomise = "Nonparam",
                      SnPM = "Nonparam",
                      TFCE = "Nonparam",
                      ARI = "Other",
                      BSR = "Other",
                      ETAC = "Other",
                      PALM = "Other",
                      SnPM = "Other"),
         Confidence = as.ordered(narps_df$Confidence)) 


narps_df$testing[is.na(narps_df$testing)] <- "Other"
narps_df$teamID = as.factor(narps_df$teamID)

```

Estimate correlation between reported smoothing kernel and estimated image smoothness.

```{r smoothCorr}
cor(narps_df$fwhm,narps_df$TSc_smoothing,use='pairwise.complete',method='spearman')
```


### Models


First run mixed models across full dataset to assess overall effects on hypothesis acceptance.

```{r fullModel}
hyp_df = narps_df %>% drop_na(fwhm,used_fmriprep_data,
                                    package,
                                    testing)
m_hyp_full = glmer(Decision ~ varnum + fwhm + used_fmriprep_data + package + testing + (1|teamID),
            data = hyp_df,family=binomial,
            control = glmerControl(optimizer = "bobyqa"),nAGQ = 10)
summary(m_hyp_full)
r.squaredGLMM(m_hyp_full)

```

#### Model comparisons

Model without smoothing

```{r nosmoothModel}
m_hyp_nosmooth = glmer(Decision ~ varnum + used_fmriprep_data + package + testing + (1|teamID),
            data = hyp_df,family=binomial,
            control = glmerControl(optimizer = "bobyqa"),nAGQ = 10)
cat('\ntesting effect of smoothing\n')
anova(m_hyp_full,m_hyp_nosmooth,test='Chisq')
emtrends(m_hyp_full,specs='fwhm',var='fwhm')
# compute delta r-squared between this model and full model
r.squaredGLMM(m_hyp_full) - r.squaredGLMM(m_hyp_nosmooth) 

```

Model without fmriprep

```{r noprepModel}
m_hyp_noprep = glmer(Decision ~ varnum + fwhm + package + testing + (1|teamID),
            data = hyp_df,family=binomial,
            control = glmerControl(optimizer = "bobyqa"),nAGQ = 10)
cat('\ntesting effect of fmriprep\n')
anova(m_hyp_full,m_hyp_noprep,test='Chisq')
emmeans(m_hyp_full,'used_fmriprep_data')
# compute delta r-squared between this model and full model
r.squaredGLMM(m_hyp_full) - r.squaredGLMM(m_hyp_noprep) 


```

```{r nopackageModel}


m_hyp_nopackage = glmer(Decision ~ varnum + used_fmriprep_data + fwhm + testing + (1|teamID),
            data = hyp_df,family=binomial,
            control = glmerControl(optimizer = "bobyqa"),nAGQ = 10) 
cat('\ntesting effect of package\n')
anova(m_hyp_full,m_hyp_nopackage,test='Chisq')
leastsquare = emmeans(m_hyp_full,'package')
CLD(leastsquare, 
    alpha=.05,  
    Letters=letters)
# compute delta r-squared between this model and full model
r.squaredGLMM(m_hyp_full) - r.squaredGLMM(m_hyp_nopackage)

```

```{r notestingModel}
  
m_hyp_notesting = glmer(Decision ~ varnum + used_fmriprep_data + fwhm + package + (1|teamID),
            data = hyp_df,family=binomial,
            control = glmerControl(optimizer = "bobyqa"),nAGQ = 10)   
cat('\ntesting effect of testing\n')
anova(m_hyp_full,m_hyp_notesting,test='Chisq')
leastsquare = emmeans(m_hyp_full,'testing')
CLD(leastsquare, 
    alpha=.05,  
    Letters=letters)

# compute delta r-squared between this model and full model
r.squaredGLMM(m_hyp_full) - r.squaredGLMM(m_hyp_notesting)

```

Full model using specified smoothing filter rather than estimated smoothness.

```{r}
m_hyp_full = glmer(Decision ~ varnum + TSc_smoothing + used_fmriprep_data + package + testing + (1|teamID),
            data = hyp_df,family=binomial,
            control = glmerControl(optimizer = "bobyqa"),nAGQ = 10)
summary(m_hyp_full)

```


For each hypothesis, we ask whether decisions are associated with fwhm and use of fmriprep.  None of these survive Bonferroni correction.

```{r}

runModels = function(hyp){
  pvals = c()
  hyp_df = narps_df %>% filter(varnum==!!hyp) %>% drop_na(fwhm,
                                            used_fmriprep_data,
                                            package,
                                            testing)
  m_hyp_full = bayesglm(Decision ~ fwhm + used_fmriprep_data + package + testing,
                   data = hyp_df,family=binomial)
  
  m_hyp_nosmooth = bayesglm(Decision ~ used_fmriprep_data + package + testing,
                   data = hyp_df,family=binomial)
  #cat('testing effect of smoothing\n')
  a = anova(m_hyp_full,m_hyp_nosmooth,test='Chisq')
  pvals = c(pvals,unlist(a)['Pr(>Chi)2'])
  
  m_hyp_noprep = bayesglm(Decision ~ fwhm + package + testing,
                   data = hyp_df,family=binomial)
  #cat('testing effect of fmriprep\n')
  a=anova(m_hyp_full,m_hyp_noprep,test='Chisq')
  pvals = c(pvals,unlist(a)['Pr(>Chi)2'])
  
  m_hyp_nopackage = bayesglm(Decision ~ used_fmriprep_data + fwhm + testing,
                   data = hyp_df,family=binomial)
  #cat('testing effect of package\n')
  a=anova(m_hyp_full,m_hyp_nopackage,test='Chisq')
  pvals = c(pvals,unlist(a)['Pr(>Chi)2'])
  
  
  m_hyp_notesting = bayesglm(Decision ~ used_fmriprep_data + fwhm + package,
                   data = hyp_df,family=binomial)
  #cat('testing effect of testing\n')
  a=anova(m_hyp_full,m_hyp_notesting,test='Chisq')
  pvals = c(pvals,unlist(a)['Pr(>Chi)2'])
  return(pvals)
}
```



```{r}
all_pvals = c()
for (hyp in 1:9){
  pv = runModels(hyp)
  all_pvals = rbind(all_pvals,pv)
}

```

### Plot the data

#### decision vs. software package

```{r}
decisionSummary_package <- narps_df %>%
  drop_na(package) %>%
  group_by(package,varnum) %>%
  summarize(meanAccept = mean(Decision),
            numTeams = n()) 

ggplot(decisionSummary_package,aes(varnum,meanAccept,color=package,group=package)) +
  geom_line(aes(size=numTeams))

```


#### decision vs. use of fMRIprep

```{r}
decisionSummary_fmriprep <- narps_df %>%
  drop_na(used_fmriprep_data) %>%
  group_by(used_fmriprep_data,varnum) %>%
  summarize(meanAccept = mean(Decision),
            numTeams = n()) 

ggplot(decisionSummary_fmriprep,aes(varnum,meanAccept,color=used_fmriprep_data)) +
  geom_line() +
  scale_x_continuous(name='Hypotheses',breaks=seq(1,9,1))

```


#### decision vs. Effects of smoothing

First we examine the effect of actual image smoothness, estimated using FSL.

```{r}
decisionSummary_smoothing <- narps_df %>%
  drop_na(fwhm) %>%
  mutate(Decision_factor = as.factor(Decision)) %>%
  group_by(Decision_factor,varnum) %>%
  summarize(meanFWHM = mean(fwhm),
            numTeams = n()) 

ggplot(decisionSummary_smoothing,aes(varnum,meanFWHM,color=Decision_factor,group=Decision_factor)) +
  geom_line() 
  

```

effect of low vs high smoothing
```{r}
narps_df$FWHMhi=narps_df$fwhm>=10
decisionSummary_FWHMhilo <- narps_df %>%
  drop_na(FWHMhi) %>%
  group_by(FWHMhi,varnum) %>%
  summarize(meanAccept = mean(Decision),
            numTeams = n()) 

ggplot(decisionSummary_FWHMhilo,aes(varnum,meanAccept,color=FWHMhi)) +
  geom_line() +
  scale_x_continuous(name='Hypotheses',breaks=seq(1,9,1))

```


effect of the applied smoothing kernel.

```{r}
decisionSummary_smoothingkernel <- narps_df %>%
  drop_na(fwhm) %>%
  mutate(Decision_factor = as.factor(Decision)) %>%
  group_by(Decision_factor,varnum) %>%
  summarize(meanAppliedFWHM = mean(TSc_smoothing),
            numTeams = n()) 

ggplot(decisionSummary_smoothingkernel,aes(varnum,meanAppliedFWHM,color=Decision_factor)) +
  geom_line() +
  scale_x_continuous(name='Hypotheses',breaks=seq(1,9,1))
  

```


### Examine effects of various factors on pattern distance

```{r}

patterndist_df = read_csv('/Users/nichols/git/narps-poldrack/mean_pattern_distance.csv',skip=0)
names(patterndist_df)=c('teamID','mean_distance')

merged_df = join(patterndist_df,narps_df %>% filter(varnum==1),by=c('teamID'))
```

### fit model



```{r}
r2z = function(r){
    # fisher transform
    z=0.5*log((1.0+r)/(1.0-r))
    z[is.na(z)]=0
    return(z)
}
merged_df <- merged_df %>%
  mutate(z_mean_distance = r2z(mean_distance))

merged_df = merged_df %>% drop_na(fwhm,used_fmriprep_data,
                                    package,
                                    testing)

dist_hyp_full = lm(z_mean_distance ~ fwhm + used_fmriprep_data + package + testing,
            data = merged_df)
s= summary(dist_hyp_full)
print(s)

dist_hyp_nosmooth = lm(z_mean_distance ~ used_fmriprep_data + package + testing,
            data = merged_df)
cat('\ntesting effect of smoothing\n')
anova(dist_hyp_full,dist_hyp_nosmooth,test='Chisq')
emtrends(dist_hyp_full,specs='fwhm',var='fwhm')
s$r.squared - summary(dist_hyp_nosmooth)$r.squared

dist_hyp_noprep = lm(z_mean_distance ~ fwhm + package + testing,
            data = merged_df)
cat('\ntesting effect of fmriprep\n')
anova(dist_hyp_full,dist_hyp_noprep,test='Chisq')
emmeans(dist_hyp_full,'used_fmriprep_data')
s$r.squared - summary(dist_hyp_noprep)$r.squared


dist_hyp_nopackage = lm(z_mean_distance ~ used_fmriprep_data + fwhm + testing,
            data = merged_df) 
cat('\ntesting effect of package\n')
anova(dist_hyp_full,dist_hyp_nopackage,test='Chisq')
s$r.squared - summary(dist_hyp_nopackage)$r.squared
leastsquare = emmeans(dist_hyp_full,'package')
CLD(leastsquare, 
    alpha=.05,  
    Letters=letters)


  
dist_hyp_notesting = lm(z_mean_distance ~ used_fmriprep_data + fwhm + package,
            data = merged_df)   
cat('\ntesting effect of testing\n')
anova(dist_hyp_full,dist_hyp_notesting,test='Chisq')
s$r.squared - summary(dist_hyp_notesting)$r.squared

leastsquare = emmeans(dist_hyp_full,'testing')
CLD(leastsquare, 
    alpha=.05,  
    Letters=letters)


```

